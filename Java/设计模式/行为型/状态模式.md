# 状态模式

## ※引用传递：对于this的合理运用※

## 定义

 有限状态机，英文翻译是 Finite State Machine，缩写为 FSM，简称为状态机。状态机有 3 个组成部分：状态（State）、事件（Event）、动作（Action）。其中，事件也称为转移条件（Transition Condition）。事件触发状态的转移及动作的执行。不过，动作不是必须的，也可能只转移状态，不执行任何动作。 

 **当我们发现，流程和下图类似时（状态闭环）时，考虑状态模式**![img](https://static001.geekbang.org/resource/image/5a/6c/5aa0310b9b3ea08794cfc2f376c8f96c.jpg) 

------

## 实现

1.  状态机实现方式一：分支逻辑法 。 参照状态转移图，将每一个状态转移，原模原样地直译成代码 

2.  状态机实现方式二：查表法。当状态转移带有复杂操作，比如记录日志，发送请求时，二维数组不能完整表示。

   ![img](https://static001.geekbang.org/resource/image/4f/91/4f4ea3787bd955918578181e18173491.jpg) 

3.  状态机实现方式三：状态模式 。由状态机持有变量，操作交由内部的每一种状态去实际处理。注意，这里是双向依赖，**状态机和状态互相持有引用（状态机传递this给状态，状态使用单例模式）**，因为状态需要去改变状态机的状态。

###  查表法 vs 状态模式

实际上，像游戏这种**比较复杂的状态机**，包含的状态比较多，我优先推荐使用**查表法**，而状态模式会引入非常多的状态类，会导致代码比较难维护。

相反，像电商下单、外卖下单这种类型的状态机，它们的**状态并不多，状态转移也比较简单**，但事件触发执行的动作包含的业务逻辑可能会比较复杂，所以，更加推荐使用状态模式来实现。 

实际上如果使用状态模式，先把状态转移图画出。

------

