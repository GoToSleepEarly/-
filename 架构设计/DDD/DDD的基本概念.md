## Q：DDD解决的核心问题？

A：核心是**解耦**。 DDD 核心思想是通过领域驱动设计方法定义领域模型，从而确定业务和应用边界，保证**业务模型与代码模型的一致性**。 

## Q：DDD的两个步骤？

A：战略设计和战术设计，从重构的角度看，战略设计是核心。 

战略设计主要从业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。

战术设计则从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。 

## Q：如何进行战略设计？

 A：**事件风暴**是建立领域模型的主要方法，它是一个从发散到收敛的过程。它通常采用用例分析、场景分析和用户旅程分析，尽可能全面不遗漏地分解业务领域，并梳理领域对象之间的关系，这是一个发散的过程。事件风暴过程会产生很多的实体、命令、事件等领域对象，我们将这些领域对象从不同的维度进行聚类，形成如聚合、限界上下文等边界，建立领域模型，这就是一个收敛的过程。 

 ![img](https://static001.geekbang.org/resource/image/3b/73/3bb8915fd6e880d64e9029a1f8677473.jpg) 

## Q：如何划分领域模型和微服务的边界？

A： 我们可以用三步来划定领域模型和微服务的边界。

第一步：在事件风暴中梳理业务过程中的用户操作、事件以及外部依赖关系等，根据这些要素梳理出领域实体等领域对象。

第二步：根据领域实体之间的业务关联性，将业务紧密相关的实体进行组合形成聚合，同时确定聚合中的聚合根、值对象和实体。在这个图里，聚合之间的边界是第一层边界，它们在同一个微服务实例中运行，这个边界是逻辑边界，所以用虚线表示。

第三步：根据业务及语义边界等因素，将一个或者多个聚合划定在一个限界上下文内，形成领域模型。在这个图里，限界上下文之间的边界是第二层边界，这一层边界可能就是未来微服务的边界，不同限界上下文内的领域逻辑被隔离在不同的微服务实例中运行，物理上相互隔离，所以是物理边界，边界之间用实线来表示。 

## Q：如何区分领域和子域？

A： DDD 的领域就是这个边界内要解决的业务问题域。 领域可进一步划分为子域， 我们把划分出来的多个子领域称为子域，每个子域对应一个更小的问题域或更小的业务范围。

所以领域由子域构成，子域也可以当成领域，只是抽象上的包含关系。

## Q： 如何理解核心域、通用域和支撑域？ 

A： 决定产品和公司核心竞争力的子域是核心域，它是业务成功的主要因素和公司的核心竞争力。没有太多个性化的诉求，同时被多个子域使用的通用功能子域是通用域。还有一种功能子域是必需的，但既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的子域，它就是支撑域。 

目前来说，我们专注于核心域就行。认证、权限一类的系统即为通用域（可以买到）、而非核心领域而又需要定制，则为支撑域。

## Q：如何理解限界上下文（ Bounded Context  ）？

A： 本质上是为了唯一的划分每个领域的边界及领域内术语的统一（避免二义性），从而细化出的上下文边界。英文能更好的区分，Bounded=边界，Context=上下文，即不同解空间之间的边界。（比如商品，在销售上下文、物流上下文、优惠券上下文是不同的实体和对象，需要区分开）

 一般说来，为了方便开发，还需建立了领域对象和代码对象的映射关系 。这样通过BC和映射，我们能确切的知道某一个业务语义如何翻译成代码。![img](https://static001.geekbang.org/resource/image/69/ee/69f44e120de5019c0fbff4d3fbc0afee.png) 

 ![img](https://static001.geekbang.org/resource/image/09/b8/09ca1ccc982d02634a856b2e80cf24b8.jpg) 

## Q：如何理解领域和限界上下文的关系？

A：领域可以说是问题域的划分，而限界上下文更倾向于解决方案空间的定义。

## Q：如何理解实体和值对象？

A： DDD 提倡从领域模型设计出发，而不是先设计数据模型 ，而最终的落点就是实体和值对象，即实体和值对象是组成领域模型的基础单元。 

- 实体具有唯一标志id，他的值可以任意变化，但是侧重考虑的是对象本身不变性（业务主体）
- 值对象通过对象属性值来识别的对象，它将多个相关属性组合为一个概念整体，当内容变化时，他就变了（u1s1，也是面向对象的体现，避免属性值零散分布）。 
- DDD倾向于业务角度拆分，一般来说，实体都有其对应的表，而值对象可以关联表，也可以序列化后当成一个或多个字段存储

 实体一般对应业务对象，它具有业务属性和业务行为；而值对象主要是属性集合，对实体的状态和特征进行描述。 

## Q：如何理解聚合？

A： **实体和值对象都只是个体化的对象，它们的行为表现出来的是个体的能力。而能让实体和值对象协同工作的组织就是聚合，它用来确保这些领域对象在实现共同的业务逻辑时，能保证数据的一致性。** 

 聚合就是由业务和逻辑紧密关联的实体和值对象组合而成的，聚合是数据修改和持久化的基本单元，每一个聚合对应一个仓储，实现数据的持久化。 

 跨多个实体的业务逻辑通过领域服务来实现，跨多个聚合的业务逻辑通过应用服务来实现。 

比如说：终端和终端组是两个聚合，将本来耦合在一起的两组对象解耦。如果判断两个终端是否在同一个网段（两个实体），则使用领域服务。如果需要查询终端和终端组的名称，则需要应用服务。

TIPS：一个实体不一定是一个聚合，一个聚合可以含括多个实体，比如订单聚合，可以包含订单本身实体以及订单细节这2个实体。

## Q：如何理解聚合根？

A： 聚合根的主要目的是为了避免由于复杂数据模型缺少统一的业务规则控制，而导致聚合、实体之间数据不一致性的问题。 

 如果把聚合比作组织，那聚合根就是这个组织的负责人。聚合根也称为根实体，它不仅是实体，还是聚合的管理者。在聚合内部负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑。 

也就是说，对聚合内东西的修改，都需要通过聚合根。外界对象没法直接访问聚合根内的实体。

## Q：如何设计聚合？

A： DDD 领域建模通常采用事件风暴，它通常采用用例分析、场景分析和用户旅程分析等方法，通过头脑风暴列出所有可能的业务行为和事件，然后找出产生这些行为的领域对象，并梳理领域对象之间的关系，找出聚合根，找出与聚合根业务紧密关联的实体和值对象，再将聚合根、实体和值对象组合，构建聚合。 

 ![img](https://static001.geekbang.org/resource/image/d4/dc/d4975de95bc31f954d11yyaee32a65dc.png) 

## Q：聚合设计的原则？

A：建议如下：

1.  在一致性边界内建模真正的不变条件。 聚合用来封装真正的不变性，而不是简单地将对象组合在一起。 也就是聚合一定要有**不变的业务关系**
2.  设计小聚合。 小聚合 =》 小领域服务 =》通过应用服务组织User Case
3.  通过唯一标识引用其它聚合。 剩下的通过冗余值对象存储
4.  在边界之外使用最终一致性。 这一点不太好做到
5.  通过应用层实现跨聚合的服务调用。 防止以后代码拆分时，领域服务需要额外再拆分一次，而应用服务可以通过Facade直接调用。 应避免跨聚合的领域服务调用和跨聚合的数据库表关联。 

